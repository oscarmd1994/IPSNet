<div class="container bg-white pb-3 rounded">
    <div class="h4 px-5 py-3">Datos generales de la nueva empresa</div>
    <div class="dropdown-divider mb-3"></div>
    <form id="form_inEmpresa" class="needs-validation" novalidate>

        <div class="form-row">

            <div class="form-group col-md-2">
                <label for="inId_empresa" class=" col-form-label">ID EMPRESA</label>
                <input class="form-control" type="text" name="inId_empresa" id="inId_empresa" disabled>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-10">
                <label for="inNombre_empresa" class=" col-form-label">Nombre Empresa</label>
                <input class="form-control " type="text" name="inNombre_empresa" id="inNombre_empresa" placeholder="Escribe la razón social de la empresa" required>
                <div class="invalid-feedback">
                    Ingrese la razon social de la empresa
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="inNomCorto_empresa">Nombre Corto</label>
                <input type="text" class="form-control" name="inNomCorto_empresa" id="inNomCorto_empresa" placeholder="Escribe el nombre corto de la empresa" required>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="inGiro_empresa">RFC de la empresa</label>
                <input type="text" class="form-control" name="inGiro_empresa" id="inRfc_empresa" placeholder="Escribe en RFC de la empresa" maxlength="12" required>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="inGiro_empresa">Giro de la empresa</label>
                <input type="text" class="form-control" name="inGiro_empresa" id="inGiro_empresa" placeholder="Escribe en giro de la empresa" required>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="validationServerUsername">Centros de Costos</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text btn btn-secondary" id="btnShowRegistroPatronal"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" class="form-control" id="validationServerUsername" placeholder="Agrega uno o mas centro de costos" aria-describedby="inputGroupPrepend3" required disabled>
                    <div class="invalid-feedback">

                    </div>
                </div>
            </div>
            <div class="h5 px-5 py-3 text-muted col-md-12"><span class="fas fa-circle"></span> Direccion de la empresa</div>
            <div class="dropdown-divider mb-3"></div>
            <div class="form-group col-md-2">
                <label for="inCodigo_postal">Codigo Postal</label>
                <input type="text" maxlength="5" size="5" class="form-control input-number" min="0" name="inCodigo_postal" id="inCodigo_postal" required>
                <div class="invalid-feedback">

                </div>
            </div>
            <div class="form-group col-md-2">
                <label for="">Validar CP</label>
                <button class="form-control btn btn-secondary" type="button" id="btnValidaCpEstado">
                    &nbsp;Valida CP
                </button>
            </div>
            <div class="form-group col-md-5">
                <label for="inEstado_empresa">Estado</label>
                <select class="form-control custom-select" name="inEstado_empresa" id="inEstado_empresa" required>
                </select>
                <div class="invalid-feedback">

                </div>
            </div>

            <div class="form-group col-md-3">
                <label for="inDelegacion_empresa">Municipio</label>
                <select class="form-control custom-select" name="inMunicipio_empresa" id="inMunicipio_empresa">
                </select>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="inCiudad_empresa">Cuidad</label>
                <select class="form-control custom-select" name="inCiudad_empresa" id="inCiudad_empresa" required>
                </select>
                <div class="invalid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="inColonia_empresa">Colonia</label>
                <select class="form-control  custom-select" name="inColonia_empresa" id="inColonia_empresa" required>
                </select>
                <div class="valid-feedback">

                </div>
            </div>
            <div class="form-group col-md-12">
                <label for="inCalle_Empresa">Calle</label>
                <input class="form-control" type="text" name="inCalle_Empresa" value="" placeholder="Ingrese la calle de la empresa" autocomplete="off" required />
                <div class="invalid-feedback">

                </div>
            </div>
            <div class="form-group col-md-6">
                <div class="h5 px-5 py-3 text-muted"><span class="fas fa-circle"></span> Numero de nomina automaticos</div>
                <div class="dropdown-divider mb-3"></div>
                <div class="form-row">
                    <label for="inUltimo_nomina" class="col-md-3">Ultimo</label>
                    <input class="col-md-7 form-control mb-2 input-number" type="text" min="0" name="inUltimo_nomina" id="inUltimo_nomina" required>
                    <div class="invalid-feedback">

                    </div>
                </div>
                <div class="form-row">
                    <label for="inInicio_nomina" class="col-md-3">Inicial</label>
                    <input class="col-md-7 form-control mb-2 input-number" type="text" min="0" name="inInicio_nomina" id="inInicio_nomina" required>
                    <div class="invalid-feedback">

                    </div>
                </div>
                <div class="form-row">
                    <label for="inFinal_nomina" class="col-md-3">Final</label>
                    <input class="col-md-7 form-control mb-2 input-number" type="text" min="0" name="inFinal_nomina" id="inFinal_nomina" required>
                    <div class="invalid-feedback">

                    </div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <div class="h5 px-5 py-3 text-muted"><span class="fas fa-circle"></span> Asignación primaria de Sueldo</div>
                <div class="dropdown-divider mb-3"></div>
                <div class="form-row">
                    <label for="inPeriodo_pago" class="col-md-3">Periodo de pago: </label>
                    <select class="form-control col-md-7 mb-2  custom-select" name="inPeriodo_pago" id="inPeriodo_pago" required>
                        <option value="0" class="">Semanal</option>
                        <option value="2">Catorcenal</option>
                        <option value="3" selected="selected">Quincenal</option>
                        <option value="4">Mensual</option>
                    </select>
                    <div class="invalid-feedback">

                    </div>
                </div>
                <div class="form-row">
                    <label for="inPago" class="col-md-3">Se paga por: </label>
                    <select class="form-control col-md-7 mb-2 custom-select" name="inPago" id="inPago" required>
                        <option value="0" class="">Horas</option>
                        <option value="1"> Días</option>
                        <option value="2" selected>Periodos completos</option>
                    </select>
                    <div class="invalid-feedback">

                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <input class="btn btn-primary py-4 px-4" type="submit" name="btn_saveEmpresa" id="btn_saveEmpresa" value="Guardar Empresa" />
        </div>
    </form>
    <div class="modal" tabindex="-1" id="modalCCostos" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agrega Centros de Costos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-x:scroll;overflow-y:scroll;">
                    <table class="table table-striped table-sm text-center">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">Afiliacion Imss</th>
                                <th scope="col">Descripcion</th>
                                <th scope="col">Estado</th>
                                <th scope="col">Riesgo de Trabajo</th>
                                <th scope="col">Status</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">B4598563214</th>
                                <td>Grupo SERI</td>
                                <td>Zacatecas</td>
                                <td>0.0048651212</td>
                                <td>Activo</td>
                                <td class="">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">B9865548725</th>
                                <td>Grupo SERI</td>
                                <td>Sonora</td>
                                <td>0.0048651212</td>
                                <td>Activo</td>
                                <td class="">
                                    <div class="btn-group" role="group">

                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">B5656565983</th>
                                <td>Grupo SERI</td>
                                <td>Guerrero</td>
                                <td>0.0048651212</td>
                                <td>Activo</td>
                                <td class="">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">C4246973158</th>
                                <td>Grupo SERI</td>
                                <td>México</td>
                                <td>0.0048651212</td>
                                <td>Activo</td>
                                <td class="">
                                    <div class="btn-group" role="group">

                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">A5183768481</th>
                                <td>Grupo SERI</td>
                                <td>CDMX</td>
                                <td>0.0048651212</td>
                                <td>Activo</td>
                                <td class="">
                                    <div class="btn-group" role="group">

                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">B1223546591</th>
                                <td>Grupo SERI</td>
                                <td>Quintana Roo</td>
                                <td>0.0048651212</td>
                                <td>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="customSwitch1">
                                        <label class="custom-control-label" for="customSwitch1">Activo</label>
                                    </div>
                                </td>
                                <td class="">
                                    <div class="btn-group" role="group">

                                        <button type="button" class="btn btn-danger btn-sm">
                                            <i class="fas fa-minus-circle text-white"></i>
                                        </button>

                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6">
                                    <div class="text-center h4">Agregar Nuevo</div>
                                    
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3">
                                </td>
                                <td>
                                    <input type="text" class="form-control" id="inDescRP" aria-describedby="basic-addon3">
                                </td>
                                <td>
                                    <select class="custom-select" id="inSelectRegistroPatronal"></select>
                                </td>
                                <td>
                                    <input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3">
                                </td>
                                <td>
                                    <select class="custom-select" id="inSelectSRP">
                                        <option value="0">Inactivo</option>
                                        <option value="1" selected>Activo</option>
                                    </select>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-success">
                                        <i class="fas fa-plus-circle text-white"></i>
                                    </button>
                                </td>

                            </tr>

                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>

    // patron del RFC, persona moral
    _rfc_pattern_pm = "^(([A-ZÑ&]{3})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3}))$";
    // patron del RFC, persona fisica
    _rfc_pattern_pf = "^(([A-ZÑ&]{4})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3}))$";
    // 
    var codpost = document.getElementById('inCodigo_postal');
    var city = document.getElementById('inCiudad_empresa');
    var colony = document.getElementById('inColonia_empresa');
    var municipio = document.getElementById("inMunicipio_empresa");
    var states = document.getElementById("inEstado_empresa");
    var btnvalidacpstate = document.getElementById("btnValidaCpEstado");
    var modalStates = document.getElementById("inSelectRegistroPatronal");
    $(document).ready(function () {
        btnvalidacpstate.disabled = true;
        city.disabled = true;
        municipio.disabled = true;
        states.disabled = true;
        colony.disabled = true;
        $.ajax({
            url: "../Empleados/LoadStates",
            type: "POST",
            data: {},
            contentType: "application/json; charset=utf-8",
            success: (data) => {
                for (i = 0; i < data.length; i++) {
                    //states.innerHTML += `<option value="${data[i].iId}">${data[i].sValor}</option>`;
                    modalStates.innerHTML += `<option value="${data[i].iId}">${data[i].sValor}</option>`;
                }
            }
        });//Carga estados 
        //$.ajax({
        //    url: "../Empresas/New_ClaveEmpresa",
        //    type: "POST",
        //    data: {},
        //    contentType: "application/json; charset=utf-8",
        //    success: (data) => {
        //        //console.log(data);
        //        document.getElementById("inId_empresa").disabled = false;
        //        document.getElementById("inId_empresa").value = data;
        //        document.getElementById("inId_empresa").disabled = true;
        //    }
        //});//Carga nuevos
        $("#btnValidaCpEstado").on("click", function () {
            fvalidatestatecodpost();
        });
        fvalidatestatecodpost = () => {
            if (codpost.value.length === 5) {
                setTimeout(() => {
                    $.ajax({
                        url: "../Empleados/LoadInformationHome",
                        type: "POST",
                        data: { codepost: codpost.value },

                        success: (data) => {
                            if (data.length > 0) {
                                city.disabled = false;
                                municipio.disabled = false;
                                colony.disabled = false;
                                states.disabled = false;
                                $("#inColonia_empresa").empty();
                                for (i = 0; i < data.length; i++) {
                                    if (data[i].sColonia != "") {
                                        colony.innerHTML += `<option value='${data[i].sColonia}'>${data[i].sColonia}</option>`;
                                        //colony.classList.add("is-valid");
                                        municipio.innerHTML = `<option value='${data[i].sMensaje}' >${data[i].sMensaje}</option>`;
                                        states.innerHTML = `<option value='${data[i].sValor}' >${data[i].sValor}</option>`;
                                        if (data[i].sCiudad.length != 0) {
                                            city.innerHTML = `<option value='${data[i].sCiudad}'>${data[i].sCiudad}</option>`;
                                        } else {
                                            city.innerHTML = `<option value='Domicilio conocido'>Domicilio conocido </option>`;
                                        }
                                    }
                                }
                                setTimeout(() => {
                                    colony.focus();
                                }, 500);
                            } else {
                                Swal.fire({
                                    title: "Atención",
                                    text: "El código postal ingresado es incorrecto",
                                    icon: "warning",
                                    showClass: { popup: 'animated fadeInDown faster' },
                                    hideClass: { popup: 'animated fadeOutUp faster' },
                                    confirmButtonText: "Aceptar", allowOutsideClick: false, allowEscapeKey: false, allowEnterKey: false,
                                }).then((acepta) => {
                                    setTimeout(() => { codpost.focus(); }, 800)
                                });
                            }
                        }, error: (jqXHR, exception) => {
                            fcaptureaerrorsajax(jqXHR, exception);
                        }
                    });
                }, 1500);
            } else {
                Swal.fire({
                    title: "Atención", text: "El código postal debe de contener 5 caracteres", icon: "warning",
                    showClass: { popup: 'animated fadeInDown faster' },
                    hideClass: { popup: 'animated fadeOutUp faster' },
                    confirmButtonText: "Aceptar", allowOutsideClick: false, allowEscapeKey: false, allowEnterKey: false,
                }).then((acepta) => {

                    setTimeout(() => { codpost.focus(); }, 800);
                });
            }
        }
    });
    $("#inCodigo_postal").on("keyup", function (evt) {
        var i = $(this).val();
        //alert(i.length);
        if (i.length == 5) {
            btnvalidacpstate.disabled = false;
            $("#btnValidaCpEstado").removeClass("btn-secondary");
            $("#btnValidaCpEstado").addClass("btn-info");
        } else {
            btnvalidacpstate.disabled = true;
            $("#btnValidaCpEstado").removeClass("btn-info");
            $("#btnValidaCpEstado").addClass("btn-secondary");
        }
    });
    $("#inRfc_empresa").on("keyup", function (evt) {
        var rfc = $("#inRfc_empresa").val();
        if (rfc.length === 12) {
            ValidaRFC();
        } else {
            if ($("#inRfc_empresa").hasClass("is-invalid")) { }
            else { $("#inRfc_empresa").addClass("is-invalid"); }
        }
        function ValidaRFC() {
            if (rfc.match(_rfc_pattern_pm)) {
                $("#inRfc_empresa").removeClass("is-invalid");
                $("#inRfc_empresa").addClass("is-valid");
                return true;
            } else {
                $("#inRfc_empresa").removeClass("is-valid");
                $("#inRfc_empresa").addClass("is-invalid");
                return false;
            }
        }
    });
    $('.input-number').on('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
    $("#btnShowRegistroPatronal").on('click', function () {
        var nom = document.getElementById("inNombre_empresa");
        var nomc = document.getElementById("inNomCorto_empresa");
        var rfc = document.getElementById("inRfc_empresa");
        var giro = document.getElementById("inGiro_empresa");
        var idEmpresa = document.getElementById("inId_empresa");
        if (idEmpresa.length === 0 || idEmpresa.value === "" || idEmpresa === null) {
            if (nom.length === 0 || nom.value === "" || nom === null) {
                nom.classList.add("is-invalid");
                nom.focus();
                setTimeout(function () {
                    nom.classList.remove("is-invalid");
                }, 1000);
            } else {
                nom.classList.add("is-valid");
                if (nomc.length === 0 || nomc.value === "" || nomc === null) {
                    nomc.classList.add("is-invalid");
                    nomc.focus();
                    setTimeout(function () {
                        nomc.classList.remove("is-invalid");
                    }, 1000);
                } else {
                    nomc.classList.add("is-valid");
                    if (rfc.length === 0 || rfc.value === "" || rfc === null) {
                        rfc.classList.add("is-invalid");
                        rfc.focus();
                        setTimeout(function () {
                            rfc.classList.remove("is-invalid");
                        }, 1000);
                    } else {
                        if (giro.length === 0 || giro.value === "" || giro === null) {
                            giro.classList.add("is-invalid");
                            giro.focus();
                            setTimeout(function () {
                                giro.classList.remove("is-invalid");
                            }, 1000);
                        } else {
                            giro.classList.add("is-valid");
                            Swal.fire({
                                title: "Atención",
                                html: "A partir de ahora si aceptas se creara la empresa "
                                    + "<div class'dropdown-divider'></div><h3>" + nom.value + "</h3>"
                                    + "<div class'dropdown-divider'></div><small class'text-muted'>Nombre corto: " + nomc.value
                                    + "<div class'dropdown-divider'></div>RFC: " + rfc.value
                                    + "<div class'dropdown-divider'></div>Giro: " + giro.value + "</small>",
                                icon: "warning",
                                showClass: { popup: 'animated fadeInDown faster' },
                                hideClass: { popup: 'animated fadeOutUp faster' },
                                showCancelButton:true,
                                confirmButtonText: "Aceptar", allowOutsideClick: false, allowEscapeKey: false, allowEnterKey: false,
                            }).then((acepta) => {
                            

                                setTimeout(() => {
                                    $.ajax({
                                        url: "../Empresas/Insert_Empresa_FirstStep",
                                        type: "POST",
                                        data: JSON.stringify({ nom: nom.value, nomc: nomc.value, rfc: rfc.value, giro: giro.value }),
                                        contentType: "application/json; charset=utf-8",
                                        success: (data) => {
                                            console.log(data);
                                            if (data[0] == "False") {
                                                document.getElementById("inId_empresa").disabled = false;
                                                document.getElementById("inId_empresa").value = data[1];
                                                document.getElementById("inId_empresa").disabled = true;
                                                document.getElementById("inDescRP").value = data[1];
                                                console.log(document.getElementById("inId_empresa").value);
                                                $("#modalCCostos").modal("show");
                                            } else if (data[0]=="True") {
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: '',
                                                    text: '' + data[1]
                                                },false).then(() => {
                                                    nom.focus();
                                                    nom.classList.add("is-invalid");
                                                    rfc.classList.add("is-invalid");
                                                    setTimeout(function () {
                                                        nom.classList.remove("is-invalid");
                                                        rfc.classList.remove("is-invalid");
                                                    }, 1500);
                                                });
                                            }
                                        
                                        }
                                    });

                                }, 800);

                            
                            });
                        } 
                    }
                }
            }
        } else {
            $("#modalCCostos").modal("show");
        }

        
    });
    $("#form_inEmpresa").submit(function (evt) {

        var emp = document.getElementById("form_inEmpresa");
        if (emp.checkValidity() === false) {
            evt.preventDefault();
            evt.stopPropagation();
            emp.classList.add("was-validated");
        }
        setTimeout(function () {
            $("#form_inEmpresa").removeClass("was-validated");
        }, 1000);
    });
</script>


